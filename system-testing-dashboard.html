<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelmah System Testing Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .service-status {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
        }
        .online { border-left: 4px solid #27ae60; }
        .offline { border-left: 4px solid #e74c3c; }
        .unknown { border-left: 4px solid #f39c12; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Kelmah System Testing Dashboard</h1>
            <p>Browser-based testing for microservices system (Network-aware testing approach)</p>
        </div>

        <div class="test-section">
            <h2>üìä Current Configuration</h2>
            <div id="config-status">Loading configuration...</div>
            <button onclick="loadConfiguration()">üîÑ Refresh Configuration</button>
        </div>

        <div class="test-section">
            <h2>üè• Service Health Status</h2>
            <div class="status-grid" id="service-status">
                <div class="service-status unknown">
                    <h4>API Gateway</h4>
                    <div id="api-gateway-status">Checking...</div>
                </div>
                <div class="service-status unknown">
                    <h4>Auth Service</h4>
                    <div id="auth-service-status">Checking...</div>
                </div>
                <div class="service-status unknown">
                    <h4>User Service</h4>
                    <div id="user-service-status">Checking...</div>
                </div>
                <div class="service-status unknown">
                    <h4>Job Service</h4>
                    <div id="job-service-status">Checking...</div>
                </div>
                <div class="service-status unknown">
                    <h4>Messaging Service</h4>
                    <div id="messaging-service-status">Checking...</div>
                </div>
                <div class="service-status unknown">
                    <h4>WebSocket Connection</h4>
                    <div id="websocket-status">Checking...</div>
                </div>
            </div>
            <button onclick="checkAllServices()">üîç Test All Services</button>
        </div>

        <div class="test-section">
            <h2>üîó API Endpoint Testing</h2>
            <div id="api-test-results"></div>
            <button onclick="testWorkerDashboard()">üìä Test Worker Dashboard Routes</button>
            <button onclick="testAuthFlow()">üîê Test Authentication</button>
            <button onclick="testUserEndpoints()">üë§ Test User Endpoints</button>
            <button onclick="testJobEndpoints()">üíº Test Job Endpoints</button>
        </div>

        <div class="test-section">
            <h2>üåê Real-time Features</h2>
            <div id="websocket-test-results"></div>
            <button onclick="testWebSocket()">‚ö° Test WebSocket Connection</button>
            <button onclick="testNotifications()">üîî Test Notifications</button>
        </div>

        <div class="test-section">
            <h2>üìù System Logs</h2>
            <div id="system-logs">
                <div class="test-result info">System testing dashboard initialized</div>
            </div>
            <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>
    </div>

    <script>
        let config = {};
        
        function log(message, type = 'info') {
            const logs = document.getElementById('system-logs');
            const logEntry = document.createElement('div');
            logEntry.className = `test-result ${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('system-logs').innerHTML = '<div class="test-result info">Logs cleared</div>';
        }

        async function loadConfiguration() {
            try {
                const response = await fetch('/runtime-config.json');
                config = await response.json();
                document.getElementById('config-status').innerHTML = `
                    <div class="test-result success">
                        <strong>Configuration Loaded:</strong><br>
                        ‚Ä¢ API URL: ${config.ngrokUrl}<br>
                        ‚Ä¢ WebSocket URL: ${config.websocketUrl}<br>
                        ‚Ä¢ Timestamp: ${new Date(config.timestamp).toLocaleString()}<br>
                        ‚Ä¢ Development Mode: ${config.isDevelopment ? 'Yes' : 'No'}
                    </div>
                `;
                log('Configuration loaded successfully', 'success');
            } catch (error) {
                document.getElementById('config-status').innerHTML = `
                    <div class="test-result error">
                        Failed to load configuration: ${error.message}
                    </div>
                `;
                log(`Configuration load failed: ${error.message}`, 'error');
            }
        }

        async function testService(serviceName, endpoint) {
            try {
                const url = `${config.ngrokUrl}${endpoint}`;
                const response = await fetch(url, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                const statusElement = document.getElementById(`${serviceName.toLowerCase().replace(' ', '-')}-service-status`);
                const serviceDiv = statusElement.closest('.service-status');
                
                if (response.ok) {
                    statusElement.innerHTML = `‚úÖ Online (${response.status})`;
                    serviceDiv.className = 'service-status online';
                    log(`${serviceName} is online`, 'success');
                } else {
                    statusElement.innerHTML = `‚ö†Ô∏è Issues (${response.status})`;
                    serviceDiv.className = 'service-status offline';
                    log(`${serviceName} returned status ${response.status}`, 'warning');
                }
            } catch (error) {
                const statusElement = document.getElementById(`${serviceName.toLowerCase().replace(' ', '-')}-service-status`);
                const serviceDiv = statusElement.closest('.service-status');
                statusElement.innerHTML = `‚ùå Offline (${error.message})`;
                serviceDiv.className = 'service-status offline';
                log(`${serviceName} test failed: ${error.message}`, 'error');
            }
        }

        async function checkAllServices() {
            if (!config.ngrokUrl) {
                await loadConfiguration();
            }
            
            log('Starting comprehensive service health check...', 'info');
            
            // Test all services
            await testService('API Gateway', '/health');
            await testService('Auth', '/api/auth/health');
            await testService('User', '/api/users/health');
            await testService('Job', '/api/jobs/health');
            await testService('Messaging', '/api/messages/health');
            
            // Test WebSocket
            testWebSocketConnection();
        }

        function testWebSocketConnection() {
            const statusElement = document.getElementById('websocket-status');
            const serviceDiv = statusElement.closest('.service-status');
            
            try {
                const ws = new WebSocket(config.websocketUrl);
                
                ws.onopen = () => {
                    statusElement.innerHTML = '‚úÖ Connected';
                    serviceDiv.className = 'service-status online';
                    log('WebSocket connection established', 'success');
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    statusElement.innerHTML = '‚ùå Connection failed';
                    serviceDiv.className = 'service-status offline';
                    log('WebSocket connection failed', 'error');
                };
                
                ws.onclose = (event) => {
                    if (event.code !== 1000) {
                        statusElement.innerHTML = `‚ö†Ô∏è Closed (${event.code})`;
                        serviceDiv.className = 'service-status offline';
                        log(`WebSocket closed with code ${event.code}`, 'warning');
                    }
                };
                
                // Timeout after 5 seconds
                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        ws.close();
                        statusElement.innerHTML = '‚è±Ô∏è Timeout';
                        serviceDiv.className = 'service-status offline';
                        log('WebSocket connection timed out', 'error');
                    }
                }, 5000);
                
            } catch (error) {
                statusElement.innerHTML = `‚ùå Error (${error.message})`;
                serviceDiv.className = 'service-status offline';
                log(`WebSocket test error: ${error.message}`, 'error');
            }
        }

        async function testWorkerDashboard() {
            const resultsDiv = document.getElementById('api-test-results');
            log('Testing worker dashboard routes...', 'info');
            
            const workerEndpoints = [
                '/api/users/workers/dashboard/metrics',
                '/api/users/workers/dashboard/analytics',
                '/api/users/workers/jobs/recent',
                '/api/users/workers/search'
            ];
            
            let results = '<h4>Worker Dashboard Route Tests:</h4>';
            
            for (const endpoint of workerEndpoints) {
                try {
                    const response = await fetch(`${config.ngrokUrl}${endpoint}`, {
                        headers: {
                            'ngrok-skip-browser-warning': 'true',
                            'Authorization': 'Bearer test-token' // Placeholder for testing
                        }
                    });
                    
                    const statusClass = response.ok ? 'success' : response.status === 401 ? 'warning' : 'error';
                    results += `<div class="test-result ${statusClass}">${endpoint}: ${response.status} ${response.statusText}</div>`;
                    log(`${endpoint}: ${response.status}`, statusClass);
                } catch (error) {
                    results += `<div class="test-result error">${endpoint}: Error - ${error.message}</div>`;
                    log(`${endpoint}: ${error.message}`, 'error');
                }
            }
            
            resultsDiv.innerHTML = results;
        }

        async function testAuthFlow() {
            log('Testing authentication flow...', 'info');
            // Implementation for auth testing
        }

        async function testUserEndpoints() {
            log('Testing user endpoints...', 'info');
            // Implementation for user endpoint testing
        }

        async function testJobEndpoints() {
            log('Testing job endpoints...', 'info');
            // Implementation for job endpoint testing
        }

        async function testWebSocket() {
            log('Testing WebSocket functionality...', 'info');
            testWebSocketConnection();
        }

        async function testNotifications() {
            log('Testing notification system...', 'info');
            // Implementation for notification testing
        }

        // Initialize the dashboard
        window.onload = function() {
            loadConfiguration();
            log('Testing dashboard loaded - ready for network-aware testing', 'success');
        };
    </script>
</body>
</html>
